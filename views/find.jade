extends layout
block content
    if session.user
        if success == 'true'
            div(class="success-box") Your request has been confirmed
        if success == 'false'
            div(class="error-box") Error
        div.team-members-container
            table(cellspacing="1")
                tr
                    td.header
                        span Skills &amp; Ability Levels
                    td.header
                        span Job Description
                    td.header
                        span Availability
                    td.header
                        span Request
                if !team_members.length
                    td(colspan="4") There are currently no people available
                else
                    each member in team_members
                        tr.member-row
                            td.skills(valign="top")
                                if !member.data.expert && !member.data.intermediate && !member.data.basic
                                    span No skills added
                                if member.data.expert
                                    div.skill-header Expert
                                    div.skill-content
                                        div(data-tags-input-name="expert_skills_list_#{member.data.key}", id="expertskillslist-#{member.data.key}")
                                    script.
                                        var expertSkillsList = '#{member.data.expert}';
                                        var expertSkills = expertSkillsList.split(',');

                                        $('#expertskillslist-#{member.data.key}').tagging();
                                        $("#expertskillslist-#{member.data.key} .type-zone").css("display", "none");

                                        expertSkills.map(function (skill) {
                                            $('#expertskillslist-#{member.data.key}').tagging("add", skill);
                                        });
                                if member.data.intermediate
                                    div.skill-header Intermediate
                                    div.skill-content
                                        div(data-tags-input-name="intermediate_skills_list_#{member.data.key}", id="intermediateskillslist-#{member.data.key}")
                                    script.
                                        var intermediateSkillsList = '#{member.data.intermediate}';
                                        var intermediateSkills = intermediateSkillsList.split(',');
                                        $('#intermediateskillslist-#{member.data.key}').tagging();
                                        $("#intermediateskillslist-#{member.data.key} .type-zone").css("display", "none");
                                        intermediateSkills.map(function (skill) {
                                            $('#intermediateskillslist-#{member.data.key}').tagging("add", skill);
                                        });
                                if member.data.basic
                                    div.skill-header Basic
                                    div.skill-content
                                        div(data-tags-input-name="basic_skills_list_#{member.data.key}", id="basicskillslist-#{member.data.key}")
                                    script.
                                        var basicSkillsList = '#{member.data.basic}';
                                        var basicSkills = basicSkillsList.split(',');
                                        $('#basicskillslist-#{member.data.key}').tagging();
                                        $("#basicskillslist-#{member.data.key} .type-zone").css("display", "none");
                                        basicSkills.map(function (skill) {
                                            $('#basicskillslist-#{member.data.key}').tagging("add", skill);
                                        });
                            td(valign="top")
                                span #{member.data.job_title}
                            td(valign="top")
                                span #{member.data.availability_duration.equality} #{member.data.availability_duration.number} #{member.data.availability_duration.unit}
                            td(valign="top")
                                div.request-link-container
                                    a(href="#dialog", name="modal", class="request-link", onclick="resetWindows(); updateModalFields('#{member.data.key}', '#{member.data.manager}', '#{member.data.manager_email}', '#{member.data.manager_name}');") Request
        div(id="boxes")
            div(id="dialog", class="window")
                div(id="confirm-container")
                    h1 Your request
                    form(method="post", action="/request", id="send-request", name="send-request")
                        div(class="content")
                            div.to_email
                            div.subject
                            div
                                textarea(name="body", id="body")

                        div(class="buttons-container")
                                input(type="hidden", name="team_member_id", id="team_member_id", value="")
                                input(type="hidden", name="from_email", id="from_email", value="")
                                input(type="hidden", name="to_email", id="to_email", value="")
                                input(type="hidden", name="subject", id="subject", value="")
                                input(type="hidden", name="manager", id="manager", value="")
                                input(type="hidden", name="manager_email", id="manager_email", value="")
                                input(type="button", class="cancel-button close", value="Cancel")
                                input(type="submit", class="confirm-button", value="Send")
            div(id="mask")
        script.
            function updateModalFields(team_member, manager, manager_email, manager_name) {
                $("#boxes #confirm-modal #team_member_id").val(team_member);
                $("#boxes #confirm-modal #manager").val(manager);
                $("#boxes #confirm-modal #manager_name").val(manager_name);
                $("#send-request #to_email").val(manager_email);
                $("#send-request #from_email").val('#{session.user.email}');
                $("#send-request #subject").val('Trading Places Request');
                $("#send-request .to_email").html('To: ' + manager_email);
                $("#send-request .subject").html('Subject: ' + $("#send-request #subject").val());

                var body = 'Hi ' + manager_name + ',\n\n' +
                        'Hope you are well.\n\n' +
                        'I am wondering if it\'s possible to borrow your team member (http://' + location.hostname   + '/mypeople?team_member_id=' + team_member + '#' + team_member + ') for a bit to help solve a problem we have.\n\n' +
                        'Please let me know by replying to directly to this email.\n\n' +
                        'Kind regards,\n' +
                        '#{session.user.full_name}';

                $("#send-request #body").val(body);
            }
            function showConfirmWindow() {
                $("#request-container").hide();
                $("#confirm-container").show();
            }
            function resetWindows() {
                return;
                $("#request-container").show();
                $("#confirm-container").hide();
            }

            $('#confirm-button').click(function() {
                return false;
            });

    else
        div.login-logo
            img(src='images/tradingplaces.png')
        div.error-message-box
            p.
                You must be logged in to use this page.
            br
            a.login-link(href="/") Login
